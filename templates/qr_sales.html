{% extends "base.html" %}

{% block title %}المبيعات مع QR Code - نظام إدارة السوق{% endblock %}

{% block head %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-qrcode me-2 text-primary"></i>
                نظام المبيعات مع QR Code
            </h2>
        </div>
    </div>
    
    <div class="row">
        <!-- QR Scanner Section -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-camera me-2"></i>
                        قارئ QR Code
                    </h5>
                </div>
                <div class="card-body">
                    <!-- QR Reader -->
                    <div id="qr-reader" style="width: 100%; height: 300px; border: 2px dashed #ccc; border-radius: 10px;"></div>
                    
                    <div class="mt-3 text-center">
                        <button id="start-btn" class="btn btn-success me-2">
                            <i class="fas fa-play me-1"></i>
                            تشغيل الكاميرا
                        </button>
                        <button id="stop-btn" class="btn btn-danger" style="display: none;">
                            <i class="fas fa-stop me-1"></i>
                            إيقاف الكاميرا
                        </button>
                    </div>
                    
                    <!-- Manual Product Search -->
                    <hr class="my-4">
                    <h6>أو ابحث عن المنتج يدوياً:</h6>
                    <div class="input-group">
                        <input type="text" id="manual-search" class="form-control" 
                               placeholder="اسم المنتج أو رمز المنتج">
                        <button class="btn btn-outline-primary" type="button" id="search-btn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <!-- Quick Products -->
                    <div class="mt-3">
                        <h6>منتجات سريعة:</h6>
                        <div class="row">
                            {% for product in products[:6] %}
                            <div class="col-md-6 mb-2">
                                <button class="btn btn-outline-info btn-sm w-100 quick-product" 
                                        data-product-id="{{ product.id }}">
                                    {{ product.name }} - {{ "%.2f"|format(product.price) }} جنيه
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Shopping Cart Section -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-shopping-cart me-2"></i>
                        سلة التسوق
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Customer Info -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="customerName" class="form-label">اسم العميل (اختياري)</label>
                            <input type="text" class="form-control" id="customerName" placeholder="اسم العميل">
                        </div>
                        <div class="col-md-6">
                            <label for="customerPhone" class="form-label">رقم الهاتف (اختياري)</label>
                            <input type="text" class="form-control" id="customerPhone" placeholder="رقم الهاتف">
                        </div>
                    </div>
                    
                    <!-- Cart Items -->
                    <div id="cartItems" class="mb-3" style="max-height: 300px; overflow-y: auto;">
                        <div class="text-center text-muted py-4" id="emptyCart">
                            <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                            <p>السلة فارغة</p>
                            <p class="small">امسح QR Code أو اختر منتج لإضافته</p>
                        </div>
                    </div>
                    
                    <!-- Total and Actions -->
                    <div class="border-top pt-3">
                        <div class="row align-items-center mb-3">
                            <div class="col-6">
                                <h5 class="mb-0">المجموع الكلي:</h5>
                            </div>
                            <div class="col-6 text-end">
                                <h4 class="mb-0 text-primary" id="totalAmount">0.00 جنيه</h4>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button id="checkoutBtn" class="btn btn-success btn-lg" disabled>
                                <i class="fas fa-cash-register me-2"></i>
                                إتمام البيع والطباعة المباشرة
                            </button>
                            
                            <button id="clearCartBtn" class="btn btn-outline-secondary">
                                <i class="fas fa-trash me-1"></i>
                                إفراغ السلة
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Form for Checkout -->
<form id="checkoutForm" method="POST" action="{{ url_for('process_sale') }}" style="display: none;">
    <input type="hidden" name="customer_name" id="hiddenCustomerName">
    <input type="hidden" name="customer_phone" id="hiddenCustomerPhone">
    <input type="hidden" name="cart_items" id="hiddenCartItems">
</form>
{% endblock %}

{% block scripts %}
<script>
let cart = [];
let html5QrcodeScanner = null;
let isScanning = false;

// QR Scanner Functions
function startScanner() {
    if (isScanning) return;
    
    const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.0
    };
    
    html5QrcodeScanner = new Html5Qrcode("qr-reader");
    
    Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
            html5QrcodeScanner.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanFailure
            ).then(() => {
                isScanning = true;
                document.getElementById('start-btn').style.display = 'none';
                document.getElementById('stop-btn').style.display = 'inline-block';
            }).catch(err => {
                console.error("Unable to start scanning", err);
                alert('خطأ في تشغيل الكاميرا: ' + err);
            });
        } else {
            alert('لم يتم العثور على كاميرا');
        }
    }).catch(err => {
        console.error("Unable to get cameras", err);
        alert('خطأ في الوصول للكاميرا: ' + err);
    });
}

function stopScanner() {
    if (!isScanning) return;
    
    html5QrcodeScanner.stop().then(() => {
        isScanning = false;
        document.getElementById('start-btn').style.display = 'inline-block';
        document.getElementById('stop-btn').style.display = 'none';
    }).catch(err => {
        console.error("Unable to stop scanning", err);
    });
}

function onScanSuccess(decodedText) {
    console.log(`QR Code detected: ${decodedText}`);
    
    try {
        // Try to parse as JSON first
        const qrData = JSON.parse(decodedText);
        if (qrData.product_id) {
            addProductToCart(qrData.product_id);
        }
    } catch (e) {
        // If not JSON, treat as Product ID
        addProductToCart(decodedText);
    }
}

function onScanFailure(error) {
    // Ignore scan failures (they happen frequently)
}

// Cart Functions
function addProductToCart(productId) {
    fetch(`/get_product_by_qr/${productId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showAlert('error', 'المنتج غير موجود: ' + productId);
            } else {
                addProductToCartData(data);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'خطأ في جلب بيانات المنتج');
        });
}

function addProductToCartData(product) {
    if (product.quantity === 0) {
        showAlert('warning', 'هذا المنتج غير متوفر في المخزون');
        return;
    }
    
    // Check if product already in cart
    const existingItem = cart.find(item => item.product_id === product.id);
    if (existingItem) {
        if (existingItem.quantity < product.quantity) {
            existingItem.quantity++;
            showAlert('success', `تم زيادة كمية "${product.name}"`);
        } else {
            showAlert('warning', 'لا يمكن إضافة المزيد من هذا المنتج (المخزون محدود)');
            return;
        }
    } else {
        cart.push({
            product_id: product.id,
            name: product.name,
            price: product.price,
            quantity: 1,
            max_quantity: product.quantity
        });
        showAlert('success', `تم إضافة "${product.name}" للسلة`);
    }
    
    updateCartDisplay();
}

function removeFromCart(productId) {
    cart = cart.filter(item => item.product_id !== productId);
    updateCartDisplay();
}

function updateQuantity(productId, newQuantity) {
    const item = cart.find(item => item.product_id === productId);
    if (item) {
        if (newQuantity <= 0) {
            removeFromCart(productId);
        } else if (newQuantity <= item.max_quantity) {
            item.quantity = newQuantity;
            updateCartDisplay();
        } else {
            showAlert('warning', 'الكمية المطلوبة أكبر من المخزون المتوفر');
        }
    }
}

function updateCartDisplay() {
    const cartItemsContainer = document.getElementById('cartItems');
    const emptyCart = document.getElementById('emptyCart');
    const totalAmount = document.getElementById('totalAmount');
    const checkoutBtn = document.getElementById('checkoutBtn');
    
    if (cart.length === 0) {
        cartItemsContainer.innerHTML = emptyCart.outerHTML;
        totalAmount.textContent = '0.00 جنيه';
        checkoutBtn.disabled = true;
        return;
    }
    
    let cartHTML = '';
    let total = 0;
    
    cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        total += itemTotal;
        
        cartHTML += `
            <div class="cart-item mb-3 p-3 border rounded">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="mb-0">${item.name}</h6>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${item.product_id})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="row align-items-center">
                    <div class="col-6">
                        <div class="input-group input-group-sm">
                            <button class="btn btn-outline-secondary" type="button" 
                                    onclick="updateQuantity(${item.product_id}, ${item.quantity - 1})">-</button>
                            <input type="number" class="form-control text-center" value="${item.quantity}" 
                                   min="1" max="${item.max_quantity}" readonly>
                            <button class="btn btn-outline-secondary" type="button" 
                                    onclick="updateQuantity(${item.product_id}, ${item.quantity + 1})">+</button>
                        </div>
                    </div>
                    <div class="col-6 text-end">
                        <small class="text-muted">${item.price.toFixed(2)} × ${item.quantity}</small><br>
                        <strong class="text-primary">${itemTotal.toFixed(2)} جنيه</strong>
                    </div>
                </div>
            </div>
        `;
    });
    
    cartItemsContainer.innerHTML = cartHTML;
    totalAmount.textContent = total.toFixed(2) + ' جنيه';
    checkoutBtn.disabled = false;
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    alertDiv.style.top = '20px';
    alertDiv.style.left = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.style.minWidth = '300px';
    
    let icon = 'info-circle';
    if (type === 'success') icon = 'check-circle';
    else if (type === 'error') icon = 'exclamation-circle';
    else if (type === 'warning') icon = 'exclamation-triangle';
    
    alertDiv.innerHTML = `
        <i class="fas fa-${icon} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 4000);
}

// Event Listeners
document.getElementById('start-btn').addEventListener('click', startScanner);
document.getElementById('stop-btn').addEventListener('click', stopScanner);

document.getElementById('search-btn').addEventListener('click', function() {
    const searchTerm = document.getElementById('manual-search').value.trim();
    if (searchTerm) {
        // Search by product name or ID
        addProductToCart(searchTerm);
        document.getElementById('manual-search').value = '';
    }
});

document.getElementById('manual-search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('search-btn').click();
    }
});

// Quick product buttons
document.querySelectorAll('.quick-product').forEach(btn => {
    btn.addEventListener('click', function() {
        const productId = this.dataset.productId;
        fetch(`/get_product_by_qr/P${productId}`)  // Assuming quick products use P + ID format
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    addProductToCartData(data);
                }
            });
    });
});

document.getElementById('clearCartBtn').addEventListener('click', function() {
    if (cart.length > 0 && confirm('هل أنت متأكد من إفراغ السلة؟')) {
        cart = [];
        updateCartDisplay();
    }
});

document.getElementById('checkoutBtn').addEventListener('click', function() {
    if (cart.length === 0) {
        showAlert('warning', 'السلة فارغة');
        return;
    }
    
    if (confirm('هل أنت متأكد من إتمام عملية البيع؟ سيتم طباعة الفاتورة مباشرة.')) {
        // Update hidden form fields
        document.getElementById('hiddenCustomerName').value = document.getElementById('customerName').value;
        document.getElementById('hiddenCustomerPhone').value = document.getElementById('customerPhone').value;
        document.getElementById('hiddenCartItems').value = JSON.stringify(cart);
        
        // Submit form
        document.getElementById('checkoutForm').submit();
    }
});

// Initialize cart display
updateCartDisplay();
</script>
{% endblock %}