{% extends "base.html" %}

{% block title %}قارئ QR - نظام إدارة السوق{% endblock %}

{% block head %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- QR Scanner -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>
                        <i class="fas fa-qrcode me-2"></i>
                        قارئ رمز QR
                    </h5>
                </div>
                <div class="card-body">
                    <div id="qr-reader" style="width: 100%;"></div>
                    <div class="mt-3 text-center">
                        <button id="start-btn" class="btn btn-primary">
                            <i class="fas fa-camera me-1"></i>
                            تشغيل الكاميرا
                        </button>
                        <button id="stop-btn" class="btn btn-danger" style="display: none;">
                            <i class="fas fa-stop me-1"></i>
                            إيقاف الكاميرا
                        </button>
                    </div>
                    
                    <!-- Manual Input -->
                    <div class="mt-4">
                        <hr>
                        <h6>أو أدخل رمز المنتج يدوياً:</h6>
                        <div class="input-group">
                            <input type="text" id="manual-product-id" class="form-control" 
                                   placeholder="رمز المنتج (Product ID)">
                            <button class="btn btn-outline-secondary" type="button" id="manual-search-btn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Shopping Cart -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>
                        <i class="fas fa-shopping-cart me-2"></i>
                        سلة التسوق
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Customer Info -->
                    <div class="mb-3">
                        <label for="customerName" class="form-label">اسم العميل (اختياري)</label>
                        <input type="text" class="form-control" id="customerName" placeholder="اسم العميل">
                    </div>
                    <div class="mb-3">
                        <label for="customerPhone" class="form-label">رقم الهاتف (اختياري)</label>
                        <input type="text" class="form-control" id="customerPhone" placeholder="رقم الهاتف">
                    </div>
                    
                    <!-- Cart Items -->
                    <div id="cartItems" class="mb-3">
                        <div class="text-center text-muted" id="emptyCart">
                            <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                            <p>السلة فارغة - امسح منتج لإضافته</p>
                        </div>
                    </div>
                    
                    <!-- Total -->
                    <div class="border-top pt-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>المجموع الكلي:</h5>
                            <h5 class="text-primary" id="totalAmount">0.00 جنيه</h5>
                        </div>
                        
                        <!-- Action Buttons -->
                        <button id="checkoutBtn" class="btn btn-success w-100 mb-2" disabled>
                            <i class="fas fa-cash-register me-1"></i>
                            إتمام عملية البيع
                        </button>
                        
                        <div class="btn-group w-100 mb-2" role="group">
                            <button id="printBtn" class="btn btn-info" disabled>
                                <i class="fas fa-print me-1"></i>
                                طباعة PDF
                            </button>
                            <button id="thermalPrintBtn" class="btn btn-outline-info" disabled>
                                <i class="fas fa-receipt me-1"></i>
                                إيصال حراري
                            </button>
                        </div>
                        
                        <button id="clearCartBtn" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-trash me-1"></i>
                            إفراغ السلة
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Last Sale Info -->
    <div class="row mt-4" id="lastSaleInfo" style="display: none;">
        <div class="col-12">
            <div class="alert alert-success">
                <h6><i class="fas fa-check-circle me-2"></i>تم إتمام البيع بنجاح!</h6>
                <p class="mb-0">رقم الفاتورة: <span id="lastSaleId"></span> | المبلغ: <span id="lastSaleAmount"></span> جنيه</p>
                <div class="mt-2">
                    <a href="#" id="downloadInvoiceBtn" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-download me-1"></i>
                        تحميل الفاتورة
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Checkout Form (Hidden) -->
<form id="checkoutForm" method="POST" action="{{ url_for('process_qr_sale') }}" style="display: none;">
    <input type="hidden" name="customer_name" id="hiddenCustomerName">
    <input type="hidden" name="customer_phone" id="hiddenCustomerPhone">
    <input type="hidden" name="cart_items" id="hiddenCartItems">
</form>
{% endblock %}

{% block scripts %}
<script>
let cart = [];
let html5QrcodeScanner = null;
let isScanning = false;

// QR Scanner Functions
function startScanner() {
    if (isScanning) return;
    
    const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.0
    };
    
    html5QrcodeScanner = new Html5Qrcode("qr-reader");
    
    Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
            html5QrcodeScanner.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanFailure
            ).then(() => {
                isScanning = true;
                document.getElementById('start-btn').style.display = 'none';
                document.getElementById('stop-btn').style.display = 'inline-block';
            }).catch(err => {
                console.error("Unable to start scanning", err);
                alert('خطأ في تشغيل الكاميرا: ' + err);
            });
        } else {
            alert('لم يتم العثور على كاميرا');
        }
    }).catch(err => {
        console.error("Unable to get cameras", err);
        alert('خطأ في الوصول للكاميرا: ' + err);
    });
}

function stopScanner() {
    if (!isScanning) return;
    
    html5QrcodeScanner.stop().then(() => {
        isScanning = false;
        document.getElementById('start-btn').style.display = 'inline-block';
        document.getElementById('stop-btn').style.display = 'none';
    }).catch(err => {
        console.error("Unable to stop scanning", err);
    });
}

function onScanSuccess(decodedText) {
    console.log(`QR Code detected: ${decodedText}`);
    
    try {
        // Try to parse as JSON first
        const qrData = JSON.parse(decodedText);
        if (qrData.product_id) {
            addProductToCart(qrData.product_id);
        } else if (qrData.id) {
            addProductToCartById(qrData.id);
        }
    } catch (e) {
        // If not JSON, treat as Product ID
        addProductToCart(decodedText);
    }
}

function onScanFailure(error) {
    // Ignore scan failures (they happen frequently)
}

// Cart Functions
function addProductToCart(productId) {
    fetch(`/get_product_by_id/${productId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('المنتج غير موجود: ' + productId);
            } else {
                addProductToCartData(data);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('خطأ في جلب بيانات المنتج');
        });
}

function addProductToCartById(productDbId) {
    fetch(`/get_product/${productDbId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('المنتج غير موجود');
            } else {
                addProductToCartData(data);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('خطأ في جلب بيانات المنتج');
        });
}

function addProductToCartData(product) {
    if (product.quantity === 0) {
        alert('هذا المنتج غير متوفر في المخزون');
        return;
    }
    
    // Check if product already in cart
    const existingItem = cart.find(item => item.product_id === product.id);
    if (existingItem) {
        if (existingItem.quantity < product.quantity) {
            existingItem.quantity++;
        } else {
            alert('لا يمكن إضافة المزيد من هذا المنتج (المخزون محدود)');
            return;
        }
    } else {
        cart.push({
            product_id: product.id,
            name: product.name,
            price: product.price,
            quantity: 1,
            max_quantity: product.quantity
        });
    }
    
    updateCartDisplay();
    
    // Show success message
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        تم إضافة "${product.name}" للسلة
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 3000);
}

function removeFromCart(productId) {
    cart = cart.filter(item => item.product_id !== productId);
    updateCartDisplay();
}

function updateQuantity(productId, newQuantity) {
    const item = cart.find(item => item.product_id === productId);
    if (item) {
        if (newQuantity <= 0) {
            removeFromCart(productId);
        } else if (newQuantity <= item.max_quantity) {
            item.quantity = newQuantity;
            updateCartDisplay();
        } else {
            alert('الكمية المطلوبة أكبر من المخزون المتوفر');
        }
    }
}

function updateCartDisplay() {
    const cartItemsContainer = document.getElementById('cartItems');
    const emptyCart = document.getElementById('emptyCart');
    const totalAmount = document.getElementById('totalAmount');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const printBtn = document.getElementById('printBtn');
    const thermalPrintBtn = document.getElementById('thermalPrintBtn');
    
    if (cart.length === 0) {
        emptyCart.style.display = 'block';
        cartItemsContainer.innerHTML = emptyCart.outerHTML;
        totalAmount.textContent = '0.00 جنيه';
        checkoutBtn.disabled = true;
        printBtn.disabled = true;
        thermalPrintBtn.disabled = true;
        return;
    }
    
    emptyCart.style.display = 'none';
    
    let cartHTML = '';
    let total = 0;
    
    cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        total += itemTotal;
        
        cartHTML += `
            <div class="cart-item mb-2 p-2 border rounded">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="mb-0">${item.name}</h6>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${item.product_id})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="row align-items-center">
                    <div class="col-6">
                        <div class="input-group input-group-sm">
                            <button class="btn btn-outline-secondary" type="button" 
                                    onclick="updateQuantity(${item.product_id}, ${item.quantity - 1})">-</button>
                            <input type="number" class="form-control text-center" value="${item.quantity}" 
                                   min="1" max="${item.max_quantity}" 
                                   onchange="updateQuantity(${item.product_id}, parseInt(this.value))">
                            <button class="btn btn-outline-secondary" type="button" 
                                    onclick="updateQuantity(${item.product_id}, ${item.quantity + 1})">+</button>
                        </div>
                    </div>
                    <div class="col-6 text-end">
                        <small class="text-muted">${item.price.toFixed(2)} × ${item.quantity}</small><br>
                        <strong>${itemTotal.toFixed(2)} جنيه</strong>
                    </div>
                </div>
            </div>
        `;
    });
    
    cartItemsContainer.innerHTML = cartHTML;
    totalAmount.textContent = total.toFixed(2) + ' جنيه';
    checkoutBtn.disabled = false;
    printBtn.disabled = false;
    thermalPrintBtn.disabled = false;
}

// Event Listeners
document.getElementById('start-btn').addEventListener('click', startScanner);
document.getElementById('stop-btn').addEventListener('click', stopScanner);

document.getElementById('manual-search-btn').addEventListener('click', function() {
    const productId = document.getElementById('manual-product-id').value.trim();
    if (productId) {
        addProductToCart(productId);
        document.getElementById('manual-product-id').value = '';
    }
});

document.getElementById('manual-product-id').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('manual-search-btn').click();
    }
});

document.getElementById('clearCartBtn').addEventListener('click', function() {
    if (cart.length > 0 && confirm('هل أنت متأكد من إفراغ السلة؟')) {
        cart = [];
        updateCartDisplay();
    }
});

document.getElementById('checkoutBtn').addEventListener('click', function() {
    if (cart.length === 0) {
        alert('السلة فارغة');
        return;
    }
    
    if (confirm('هل أنت متأكد من إتمام عملية البيع؟')) {
        // Update hidden form fields
        document.getElementById('hiddenCustomerName').value = document.getElementById('customerName').value;
        document.getElementById('hiddenCustomerPhone').value = document.getElementById('customerPhone').value;
        document.getElementById('hiddenCartItems').value = JSON.stringify(cart);
        
        // Submit form
        document.getElementById('checkoutForm').submit();
    }
});

// Initialize cart display
updateCartDisplay();
</script>
{% endblock %}