{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">صفحة البيع</h3>
  <div>
    <button id="btn-complete" class="btn btn-success">إتمام البيع</button>
    <button id="btn-clear" class="btn btn-outline-danger">إفراغ السلة</button>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">إضافة منتج</h5>
        <form id="manual-add" class="row g-2">
          <div class="col">
            <input type="text" id="manual-product-id" class="form-control" placeholder="كود المنتج (أو امسح QR)" autocomplete="off">
          </div>
          <div class="col-auto">
            <input type="number" id="manual-qty" class="form-control" value="1" min="1">
          </div>
          <div class="col-auto">
            <button class="btn btn-primary" type="submit">إضافة</button>
          </div>
        </form>
        <input type="text" id="qr-hidden" class="visually-hidden" autocomplete="off">
        <small class="text-muted">المسح بالـ QR سيملأ الحقل المخفي تلقائياً.</small>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">الإجمالي</h5>
        <div class="display-6">{{ '%.2f'|format(subtotal) }} EGP</div>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-striped align-middle">
        <thead>
          <tr>
            <th>الكود</th>
            <th>الاسم</th>
            <th>السعر</th>
            <th>الكمية</th>
            <th>الإجمالي</th>
            <th>إجراء</th>
          </tr>
        </thead>
        <tbody id="cart-body">
          {% for it in cart_items %}
          <tr data-pid="{{ it.product_id }}">
            <td>{{ it.product_id }}</td>
            <td>{{ it.name }}</td>
            <td>{{ '%.2f'|format(it.price_egp) }}</td>
            <td style="width:140px">
              <input type="number" class="form-control form-control-sm qty-input" value="{{ it.quantity }}" min="0">
            </td>
            <td class="line-total">{{ '%.2f'|format(it.line_total) }}</td>
            <td><button class="btn btn-sm btn-danger btn-remove">حذف</button></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
(function(){
  const hidden = document.getElementById('qr-hidden');
  const manualForm = document.getElementById('manual-add');
  const manualId = document.getElementById('manual-product-id');
  const manualQty = document.getElementById('manual-qty');
  const btnComplete = document.getElementById('btn-complete');
  const btnClear = document.getElementById('btn-clear');

  // Focus hidden input to capture QR scanner keystrokes
  function focusHidden(){ hidden.focus(); }
  window.addEventListener('load', focusHidden);
  window.addEventListener('click', focusHidden);

  // Accumulate scanner input until Enter
  let buffer = '';
  hidden.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const pid = buffer.trim();
      buffer = '';
      if (pid) addToCart(pid, 1);
      e.preventDefault();
      return;
    }
    if (e.key.length === 1) buffer += e.key;
  });

  manualForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const pid = manualId.value.trim();
    const qty = Math.max(1, parseInt(manualQty.value || '1'));
    if (!pid) return;
    await addToCart(pid, qty);
    manualId.value='';
    manualQty.value='1';
  });

  async function addToCart(product_id, quantity){
    const res = await fetch('{{ url_for('cart_add') }}',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({product_id, quantity})
    });
    const data = await res.json();
    if (!data.ok) { alert(data.message || 'خطأ'); return; }
    location.reload();
  }

  document.querySelectorAll('.qty-input').forEach((input)=>{
    input.addEventListener('change', async (e)=>{
      const tr = e.target.closest('tr');
      const pid = tr.getAttribute('data-pid');
      const qty = Math.max(0, parseInt(e.target.value||'0'));
      const res = await fetch('{{ url_for('cart_update') }}',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({product_id: pid, quantity: qty})
      });
      location.reload();
    });
  });

  document.querySelectorAll('.btn-remove').forEach((btn)=>{
    btn.addEventListener('click', async (e)=>{
      const tr = e.target.closest('tr');
      const pid = tr.getAttribute('data-pid');
      await fetch('{{ url_for('cart_update') }}',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({product_id: pid, quantity: 0})
      });
      location.reload();
    });
  });

  btnClear.addEventListener('click', async ()=>{
    await fetch('{{ url_for('cart_clear') }}', {method:'POST'});
    location.reload();
  });

  btnComplete.addEventListener('click', async ()=>{
    const res = await fetch('{{ url_for('sale_complete') }}', {method:'POST'});
    const data = await res.json();
    if (data.ok) {
      alert('تم إتمام البيع. رقم العملية: ' + data.sale_id + ' (' + data.used_lang + ')');
      location.reload();
    } else {
      alert(data.message || 'فشل إتمام البيع');
    }
  });
})();
</script>
{% endblock %}
