{% extends "base.html" %}

{% block title %}نقطة البيع - نظام إدارة السوق{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Product Selection -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5>
                        <i class="fas fa-shopping-cart me-2"></i>
                        اختيار المنتجات
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Search -->
                    <div class="mb-3">
                        <input type="text" id="productSearch" class="form-control" 
                               placeholder="ابحث عن منتج أو امسح رمز QR...">
                    </div>
                    
                    <!-- Products Grid -->
                    <div class="row" id="productsGrid">
                        {% for product in products %}
                        <div class="col-md-4 col-lg-3 mb-3 product-card" data-product-id="{{ product.id }}" 
                             data-product-name="{{ product.name }}" data-product-price="{{ product.price }}">
                            <div class="card product-item h-100" style="cursor: pointer;">
                                <div class="card-body text-center">
                                    <h6 class="card-title">{{ product.name }}</h6>
                                    <p class="text-primary fw-bold">{{ "%.2f"|format(product.price) }} جنيه</p>
                                    <p class="text-muted small">المخزون: {{ product.quantity }}</p>
                                    <button class="btn btn-sm btn-primary add-to-cart" 
                                            data-product-id="{{ product.id }}">
                                        <i class="fas fa-plus"></i>
                                        إضافة
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Shopping Cart -->
        <div class="col-md-4">
            <div class="card sticky-top">
                <div class="card-header">
                    <h5>
                        <i class="fas fa-receipt me-2"></i>
                        سلة التسوق
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Customer Info -->
                    <div class="mb-3">
                        <label for="customerName" class="form-label">اسم العميل (اختياري)</label>
                        <input type="text" class="form-control" id="customerName" placeholder="اسم العميل">
                    </div>
                    <div class="mb-3">
                        <label for="customerPhone" class="form-label">رقم الهاتف (اختياري)</label>
                        <input type="text" class="form-control" id="customerPhone" placeholder="رقم الهاتف">
                    </div>
                    
                    <!-- Cart Items -->
                    <div id="cartItems" class="mb-3">
                        <div class="text-center text-muted" id="emptyCart">
                            <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                            <p>السلة فارغة</p>
                        </div>
                    </div>
                    
                    <!-- Total -->
                    <div class="border-top pt-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>المجموع الكلي:</h5>
                            <h5 class="text-primary" id="totalAmount">0.00 جنيه</h5>
                        </div>
                        
                        <!-- Checkout Button -->
                        <button id="checkoutBtn" class="btn btn-success w-100" disabled>
                            <i class="fas fa-cash-register me-1"></i>
                            إتمام عملية البيع
                        </button>
                        
                        <button id="clearCartBtn" class="btn btn-outline-secondary w-100 mt-2">
                            <i class="fas fa-trash me-1"></i>
                            إفراغ السلة
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Checkout Form (Hidden) -->
<form id="checkoutForm" method="POST" style="display: none;">
    <input type="hidden" name="customer_name" id="hiddenCustomerName">
    <input type="hidden" name="customer_phone" id="hiddenCustomerPhone">
    <input type="hidden" name="cart_items" id="hiddenCartItems">
</form>
{% endblock %}

{% block scripts %}
<script>
let cart = [];
let products = {
    {% for product in products %}
    {{ product.id }}: {
        id: {{ product.id }},
        name: "{{ product.name }}",
        price: {{ product.price }},
        quantity: {{ product.quantity }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
};

// Add to cart functionality
document.querySelectorAll('.add-to-cart').forEach(button => {
    button.addEventListener('click', function() {
        const productId = parseInt(this.dataset.productId);
        addToCart(productId);
    });
});

// Product card click
document.querySelectorAll('.product-item').forEach(card => {
    card.addEventListener('click', function() {
        const productId = parseInt(this.closest('.product-card').dataset.productId);
        addToCart(productId);
    });
});

function addToCart(productId) {
    const product = products[productId];
    if (!product || product.quantity === 0) {
        alert('هذا المنتج غير متوفر');
        return;
    }
    
    // Check if product already in cart
    const existingItem = cart.find(item => item.product_id === productId);
    if (existingItem) {
        if (existingItem.quantity < product.quantity) {
            existingItem.quantity++;
        } else {
            alert('لا يمكن إضافة المزيد من هذا المنتج (المخزون محدود)');
            return;
        }
    } else {
        cart.push({
            product_id: productId,
            name: product.name,
            price: product.price,
            quantity: 1,
            max_quantity: product.quantity
        });
    }
    
    updateCartDisplay();
}

function removeFromCart(productId) {
    cart = cart.filter(item => item.product_id !== productId);
    updateCartDisplay();
}

function updateQuantity(productId, newQuantity) {
    const item = cart.find(item => item.product_id === productId);
    if (item) {
        if (newQuantity <= 0) {
            removeFromCart(productId);
        } else if (newQuantity <= item.max_quantity) {
            item.quantity = newQuantity;
            updateCartDisplay();
        } else {
            alert('الكمية المطلوبة أكبر من المخزون المتوفر');
        }
    }
}

function updateCartDisplay() {
    const cartItemsContainer = document.getElementById('cartItems');
    const emptyCart = document.getElementById('emptyCart');
    const totalAmount = document.getElementById('totalAmount');
    const checkoutBtn = document.getElementById('checkoutBtn');
    
    if (cart.length === 0) {
        emptyCart.style.display = 'block';
        cartItemsContainer.innerHTML = emptyCart.outerHTML;
        totalAmount.textContent = '0.00 جنيه';
        checkoutBtn.disabled = true;
        return;
    }
    
    emptyCart.style.display = 'none';
    
    let cartHTML = '';
    let total = 0;
    
    cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        total += itemTotal;
        
        cartHTML += `
            <div class="cart-item mb-2 p-2 border rounded">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="mb-0">${item.name}</h6>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${item.product_id})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="row align-items-center">
                    <div class="col-6">
                        <div class="input-group input-group-sm">
                            <button class="btn btn-outline-secondary" type="button" 
                                    onclick="updateQuantity(${item.product_id}, ${item.quantity - 1})">-</button>
                            <input type="number" class="form-control text-center" value="${item.quantity}" 
                                   min="1" max="${item.max_quantity}" 
                                   onchange="updateQuantity(${item.product_id}, parseInt(this.value))">
                            <button class="btn btn-outline-secondary" type="button" 
                                    onclick="updateQuantity(${item.product_id}, ${item.quantity + 1})">+</button>
                        </div>
                    </div>
                    <div class="col-6 text-end">
                        <small class="text-muted">${item.price.toFixed(2)} × ${item.quantity}</small><br>
                        <strong>${itemTotal.toFixed(2)} جنيه</strong>
                    </div>
                </div>
            </div>
        `;
    });
    
    cartItemsContainer.innerHTML = cartHTML;
    totalAmount.textContent = total.toFixed(2) + ' جنيه';
    checkoutBtn.disabled = false;
}

// Product search
document.getElementById('productSearch').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    document.querySelectorAll('.product-card').forEach(card => {
        const productName = card.dataset.productName.toLowerCase();
        if (productName.includes(searchTerm)) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
});

// Clear cart
document.getElementById('clearCartBtn').addEventListener('click', function() {
    if (cart.length > 0 && confirm('هل أنت متأكد من إفراغ السلة؟')) {
        cart = [];
        updateCartDisplay();
    }
});

// Checkout
document.getElementById('checkoutBtn').addEventListener('click', function() {
    if (cart.length === 0) {
        alert('السلة فارغة');
        return;
    }
    
    if (confirm('هل أنت متأكد من إتمام عملية البيع؟')) {
        // Update hidden form fields
        document.getElementById('hiddenCustomerName').value = document.getElementById('customerName').value;
        document.getElementById('hiddenCustomerPhone').value = document.getElementById('customerPhone').value;
        document.getElementById('hiddenCartItems').value = JSON.stringify(cart);
        
        // Submit form
        document.getElementById('checkoutForm').submit();
    }
});

// Initialize cart display
updateCartDisplay();
</script>
{% endblock %}
